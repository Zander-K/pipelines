name: SDET Workflow

on:
  # push:
  #   branches:
  #     - main
  pull_request:
    branches:
      - main

jobs:
  build-and-upload:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout the code
        uses: actions/checkout@v4

      - name: Create a simple file
        run: echo "This is a simple file created by GitHub Actions." > simple-file.txt

      - name: Upload the file as an artifact
        uses: actions/upload-artifact@v4
        with:
          name: simple-file
          path: simple-file.txt

      # - name: Set up Flutter
      #   uses: subosito/flutter-action@v2
      #   with:
      #       flutter-version: "3.19.x"
      #       channel: "stable"
      #       cache: true

      # - name: Install dependencies
      #   run: flutter pub get

      # - name: Generate code
      #   run: dart run build_runner build --delete-conflicting-outputs 

      # - name: Build web
      #   run: flutter build web --release --base-href="/json_editor/"

      # - name: Upload Web Build Artifact
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: web-build-sdet
      #     path: build/web

  build-and-release:
    runs-on: ubuntu-latest
    needs: build-and-upload
    permissions: write-all
      # contents: write

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Download Web Build Artifact
      uses: actions/download-artifact@v4
      with:
        name: simple-file
        path: ./build/web

    - uses: dart-lang/setup-dart@v1
      
    - name: Use Make
      run: |
        make cli

    - name: Create release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref || github.ref_name }}"

          CLI_OUTPUT=$(pipe -r \
            --source-token ${{ secrets.RELEASE_REPO_SECRET }} \
            --no-interactive \
            --notes 'This is the notes' \
            --target-repo 'Zander-K/json_editor' \
            --assets ./build/web/simple-file.txt \
            --branch "$BRANCH_NAME" )
          
          echo "CLI_OUTPUT<<EOF" >> $GITHUB_ENV
          echo -e "$CLI_OUTPUT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
      
    - name: Results
      run: |
        echo "release cli output=${{ env.CLI_OUTPUT }}"